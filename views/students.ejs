<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0 d-flex align-items-center gap-2"><i class="bi bi-people-fill"></i> Students</h1>
  <a href="/students/new" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> Add Student</a>
  </div>

<% if (typeof flashMsg !== 'undefined' && flashMsg) { %>
  <% const variants = { created: 'success', updated: 'info', deleted: 'warning' }; %>
  <div class="alert alert-<%= variants[flashMsg] || 'secondary' %> alert-dismissible fade show" role="alert">
    <% if (flashMsg === 'created') { %>Student created successfully.<% } %>
    <% if (flashMsg === 'updated') { %>Student updated successfully.<% } %>
    <% if (flashMsg === 'deleted') { %>Student deleted successfully.<% } %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

<form class="row g-2 mb-3 filters-bar" method="get" action="/students">
  <div class="col-md-3">
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" name="q" placeholder="Search (name, email, department)" value="<%= filters.q %>">
    </div>
  </div>
  <div class="col-md-2">
    <input type="text" class="form-control" name="department" placeholder="Department" value="<%= filters.department %>">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.1" min="0" max="4" class="form-control" name="minGpa" placeholder="Min GPA" value="<%= filters.minGpa %>">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.1" min="0" max="4" class="form-control" name="maxGpa" placeholder="Max GPA" value="<%= filters.maxGpa %>">
  </div>
  <input type="hidden" name="sortBy" value="gpa">
  <div class="col-md-2">
    <select class="form-select" name="order">
      <option value="desc" <%= filters.order === 'desc' ? 'selected' : '' %>>GPA ↓</option>
      <option value="asc" <%= filters.order === 'asc' ? 'selected' : '' %>>GPA ↑</option>
    </select>
  </div>
  <div class="col-md-2">
    <select class="form-select" name="limit">
      <% [5,10,20,50,100].forEach(n => { %>
        <option value="<%= n %>" <%= Number(filters.limit) === n ? 'selected' : '' %>><%= n %> per page</option>
      <% }) %>
    </select>
  </div>
  <div class="col-12 d-flex gap-2">
    <button class="btn btn-theme" type="submit">Apply</button>
    <a class="btn btn-reset-theme" href="/students">Reset</a>
  </div>
</form>

<div class="card shadow-sm">
  <div class="table-responsive">
  <table class="table table-hover align-middle mb-0">
    <thead>
      <tr>
        <th>Name</th>
        <th>Roll #</th>
        <th>Email</th>
        <th>Department</th>
        <th>
          <a href="?<%= new URLSearchParams({ ...filters, sortBy: 'gpa', order: filters.order === 'asc' ? 'desc' : 'asc', page: 1 }).toString() %>" style="text-decoration:none;color:inherit;">
            GPA
            <% if (filters.sortBy === 'gpa') { %>
              <%= filters.order === 'asc' ? '↑' : '↓' %>
            <% } %>
          </a>
        </th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if (!students || students.length === 0) { %>
        <tr><td colspan="6" class="text-center empty-state">No students found. Try adjusting filters.</td></tr>
      <% } else { %>
        <% students.forEach(s => { %>
          <tr>
            <td><a href="/students/<%= s._id %>"><%= s.name %></a></td>
            <td><%= s.rollNumber %></td>
            <td><%= s.email %></td>
            <td><%= s.department %></td>
            <td><span class="badge text-bg-light"><%= s.gpa.toFixed(2) %></span></td>
            <td>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-primary" href="/students/<%= s._id %>/edit"><i class="bi bi-pencil"></i></a>
                <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-id="<%= s._id %>"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>
        <% }) %>
      <% } %>
    </tbody>
  </table>
  </div>
</div>

<% if (pagination.totalPages > 1) { %>
  <nav aria-label="Pagination">
    <ul class="pagination">
      <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?<%= new URLSearchParams({ ...filters, page: pagination.page - 1, limit: pagination.limit }).toString() %>">Prev</a>
      </li>
      <% for (let p = 1; p <= pagination.totalPages; p++) { %>
        <li class="page-item <%= p === pagination.page ? 'active' : '' %>">
          <a class="page-link" href="?<%= new URLSearchParams({ ...filters, page: p, limit: pagination.limit }).toString() %>"><%= p %></a>
        </li>
      <% } %>
      <li class="page-item <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?<%= new URLSearchParams({ ...filters, page: pagination.page + 1, limit: pagination.limit }).toString() %>">Next</a>
      </li>
    </ul>
  </nav>
<% } %>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this student? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="post">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('confirmDeleteModal');
  modal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var id = button.getAttribute('data-id');
    var form = document.getElementById('deleteForm');
    form.setAttribute('action', '/students/' + id + '?_method=DELETE');
  });
});
</script>


